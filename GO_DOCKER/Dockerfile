# Используем официальный образ Golang версии 1.22.5 в качестве начального этапа сборки
FROM golang:1.22.5 AS build-stage

# Устанавливаем рабочую директорию в контейнере
WORKDIR /app

# Копируем все файлы из текущей директории на хосте в рабочую директорию контейнера
COPY . /app

# Устанавливаем переменную окружения CGO_ENABLED в 0, чтобы отключить использование CGO
ENV CGO_ENABLED=0

# Компилируем Go-приложение и сохраняем исполняемый файл с именем `server` в директорию /app
RUN go build -o /app/server /app/main.go

# Используем минималистичный базовый образ для финального контейнера
FROM scratch

# Устанавливаем рабочую директорию в корневую директорию контейнера
WORKDIR /

# Копируем исполняемый файл из начального этапа сборки в текущую рабочую директорию
COPY --from=build-stage /app/server server

# Открываем порт 8787 для доступа к приложению из вне
EXPOSE 8787

# Устанавливаем команду по умолчанию для запуска при старте контейнера
ENTRYPOINT [ "/server" ]
